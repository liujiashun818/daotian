(function(){"use strict";var e=this,t=this,a=function(e,a,n){function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _toConsumableArray(e){if(t.Array.isArray(e)){for(var a=0,n=t.Array(e.length);a<e.length;a++)n[a]=e[a];return n}return t.Array.from(e)}function _classCallCheck(e,a){if(!(e instanceof a))throw new t.TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,a){if(!e)throw new t.ReferenceError("this hasn't been initialised - super() hasn't been called");return!a||"object"!=typeof a&&"function"!=typeof a?e:a}function _inherits(e,a){if("function"!=typeof a&&null!==a)throw new t.TypeError("Super expression must either be null or a function, not "+typeof a);e.prototype=t.Object.create(a&&a.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),a&&(t.Object.setPrototypeOf?t.Object.setPrototypeOf(e,a):e.__proto__=a)}t.Object.defineProperty(a,"__esModule",{value:!0});var r=(n(47),n(41)),i=_interopRequireDefault(r),l=(n(49),n(48)),s=_interopRequireDefault(l),o=(n(51),n(50)),u=_interopRequireDefault(o),c=(n(633),n(199)),f=_interopRequireDefault(c),d=(n(66),n(65)),p=_interopRequireDefault(d),m=(n(630),n(318)),h=_interopRequireDefault(m),v=function(){function defineProperties(e,a){for(var n=0;n<a.length;n++){var r=a[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),t.Object.defineProperty(e,r.key,r)}}return function(e,t,a){return t&&defineProperties(e.prototype,t),a&&defineProperties(e,a),e}}(),y=n(0),_=_interopRequireDefault(y),b=n(22),g=_interopRequireDefault(b),k=h.default.Group,R=function(e){function Role(e){_classCallCheck(this,Role);var a=_possibleConstructorReturn(this,(Role.__proto__||t.Object.getPrototypeOf(Role)).call(this,e));return a.state={roles:[],permissionMap:new t.Map,selectedRoleId:""},["handleSubmit","handleRadioChange","handleCheckboxChange"].map(function(e){return a[e]=a[e].bind(a)}),a}return _inherits(Role,e),v(Role,[{key:"componentDidMount",value:function(){this.getAllDepartmentRoles(),this.getPermissions("0")}},{key:"handleSubmit",value:function(e){e.preventDefault();var t=this.state,a=t.selectedRoleId,n=t.permissionMap;if(!a)return p.default.warning("请先选择角色"),!1;var r=this.assembleCheckedIds(n);g.default.ajax({url:g.default.admin.permission.updateByRole(),type:"post",data:{role:a,item_ids:r.toString()}},function(){p.default.success("设置成功")},function(e){p.default.error("设置失败["+e+"]")})}},{key:"handleRadioChange",value:function(e){var t=e.target.value;this.setState({selectedRoleId:t}),this.getRolePermissions(t)}},{key:"handleCheckboxChange",value:function(e,t){var a=t.target.checked,n=this.state.permissionMap,r=n.get(e.parent_id),i=r.items;e.checked=a,i.set(e._id,e),r.items=i,n.set(e.parent_id,r),this.setState({permissionMap:n})}},{key:"getAllDepartmentRoles",value:function(){var e=this;g.default.ajax({url:g.default.user.getAllDepartmentRoles()},function(t){var a=e.state.roles;a.push.apply(a,_toConsumableArray(t.res.roles)),e.setState({roles:a})})}},{key:"getDepartmentRoles",value:function(e){var t=this;g.default.ajax({url:g.default.user.getDepartmentRoles(e)},function(e){var a=t.state.roles;a.push.apply(a,_toConsumableArray(e.res.roles)),t.setState({roles:a})})}},{key:"getRolePermissions",value:function(e){var t=this;g.default.ajax({url:g.default.admin.permission.getByRole(e)},function(e){var a=e.res.list,n=t.state.permissionMap;n.forEach(function(e){var t=e.items;t&&t.size>0&&(t.forEach(function(e){e.checked=!1,t.set(e._id,e)}),a.map(function(e){var a=t.get(e.item_id);a&&(a.checked=!0,t.set(a._id,a))})),e.items=t,n.set(e._id,e)}),t.setState({permissionMap:n})})}},{key:"getPermissions",value:function(e){var a=this;g.default.ajax({url:g.default.admin.permission.list(e)},function(n){var r=n.res.list,i=a.state.permissionMap;r.length>0&&("0"===t.String(e)?r.forEach(function(e){i.set(e._id,e),a.getPermissions(e._id)}):i.forEach(function(a){if(a._id===e){var n=i.get(e),l=new t.Map;r.forEach(function(e){e.checked=!1,l.set(e._id,e)}),n.items=l,i.set(e,n)}}),a.setState({permissionMap:i}))})}},{key:"assembleCheckedIds",value:function(e){var t=[];return e.forEach(function(e){var a=e.items;a&&a.size>0&&a.forEach(function(e){return e.checked&&t.push(e._id)})}),t}},{key:"renderPermission",value:function(e){var a=this,n=[];return 0===e.size?null:(e.forEach(function(e){n.push(_.default.createElement("div",{className:"mb15",key:e._id},_.default.createElement("h4",{className:"mt10 mb10"},e.name),_.default.createElement(s.default,null,e.items&&e.items.size>0&&t.Array.from(e.items.values()).map(function(e){return _.default.createElement(u.default,{span:4},_.default.createElement(f.default,{checked:e.checked,onChange:a.handleCheckboxChange.bind(a,e),key:e._id},e.name))}))))}),n)}},{key:"render",value:function(){var e=this.state,t=e.roles,a=e.permissionMap,n={display:"block",height:"36px",lineHeight:"36px"};return _.default.createElement("div",null,_.default.createElement(s.default,{className:"head-action-bar-line-sm"},_.default.createElement(u.default,{span:4},_.default.createElement("h3",{className:"action-title"},"角色类型")),_.default.createElement(u.default,{span:18},_.default.createElement("h3",{className:"action-title"},"功能")),_.default.createElement(u.default,{span:2},_.default.createElement("div",{className:"pull-right"},_.default.createElement(i.default,{type:"primary",onClick:this.handleSubmit},"保存")))),_.default.createElement(s.default,null,_.default.createElement(u.default,{span:4},_.default.createElement("div",{style:{width:200}},_.default.createElement(k,{onChange:this.handleRadioChange},t&&t.map(function(e){return _.default.createElement(h.default,{value:e._id,style:n,key:e._id},e.name)})))),_.default.createElement(u.default,{span:20},this.renderPermission(a))))}}]),Role}(_.default.Component);a.default=R},n=e,r=n.webpackJsonp;if(n.webpackJsonp!==r)throw new Error("Prepack model invariant violation: "+n.webpackJsonp);var i=[65],l={1576:a};r(i,l)}).call(this);