(function(){var e=this,t=this,a=function(e,a,n){"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,a){if(!(e instanceof a))throw new t.TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,a){if(!e)throw new t.ReferenceError("this hasn't been initialised - super() hasn't been called");return!a||"object"!=typeof a&&"function"!=typeof a?e:a}function _inherits(e,a){if("function"!=typeof a&&null!==a)throw new t.TypeError("Super expression must either be null or a function, not "+typeof a);e.prototype=t.Object.create(a&&a.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),a&&(t.Object.setPrototypeOf?t.Object.setPrototypeOf(e,a):e.__proto__=a)}t.Object.defineProperty(a,"__esModule",{value:!0});var l=(n(312),n(311)),r=_interopRequireDefault(l),d=(n(49),n(48)),i=_interopRequireDefault(d),u=(n(51),n(50)),o=_interopRequireDefault(u),s=(n(157),n(35)),c=_interopRequireDefault(s),f=(n(47),n(41)),m=_interopRequireDefault(f),p=(n(628),n(627)),b=_interopRequireDefault(p),h=(n(66),n(65)),y=_interopRequireDefault(h),_=(n(68),n(67)),v=_interopRequireDefault(_),E=(n(158),n(131)),g=_interopRequireDefault(E),N=t.Object.assign||function(e){for(var a=1;a<arguments.length;a++){var n=arguments[a];for(var l in n)t.Object.prototype.hasOwnProperty.call(n,l)&&(e[l]=n[l])}return e},k=function(){function defineProperties(e,a){for(var n=0;n<a.length;n++){var l=a[n];l.enumerable=l.enumerable||!1,l.configurable=!0,"value"in l&&(l.writable=!0),t.Object.defineProperty(e,l.key,l)}}return function(e,t,a){return t&&defineProperties(e.prototype,t),a&&defineProperties(e,a),e}}(),w=n(0),x=_interopRequireDefault(w),S=n(9),C=_interopRequireDefault(S),D=n(116),I=_interopRequireDefault(D),R=n(114),O=_interopRequireDefault(R),q=n(197),j=_interopRequireDefault(q),L=n(22),P=_interopRequireDefault(L),M=n(313),T=_interopRequireDefault(M),F=g.default.Option,A=v.default.Item;n(1784);var U=function(e){function Sale(e){_classCallCheck(this,Sale);var a=_possibleConstructorReturn(this,(Sale.__proto__||t.Object.getPrototypeOf(Sale)).call(this,e));return a.state={companyNum:P.default.getLoginUser().companyNum,customer:null,autos:null,visible:!1,btnLoading:!1,key:"",couponCardInfo:{},data:"",id:e.match.params.id||"",detail:{}},["handleSubmit","submitActivateMemberCardData"].forEach(function(e){return a[e]=a[e].bind(a)}),a}return _inherits(Sale,e),k(Sale,[{key:"componentDidMount",value:function(){this.getDetail()}},{key:"handleSubmit",value:function(e){e.preventDefault();var a=P.default.getLoginUser().isPosDevice,n=this.props.form.getFieldsValue();1===t.Number(a)&&delete n.pay_type;var l=this.state.detail;n.coupon_card_type=l.coupon_card_type,n.customer_id=l.customer_id,n.seller_user_id=l.seller_user_id,n.discount=l.discount,n.remark=l.remark,this.submitActivateMemberCardData(n)}},{key:"submitActivateMemberCardData",value:function(e){var a=this,n=P.default.getLoginUser().isPosDevice,l=0===t.Number(n)?200:2e3;if(t.Number(e.discount)<0)return void y.default.warning("优惠金额不能为负数");this.setState({btnLoading:!0});var r=P.default.coupon.activateCouponCard();P.default.ajax({url:r,data:e,type:"post"},function(e){t.window.time=t.setInterval(function(){P.default.ajax({url:P.default.coupon.getCouponOrderDetail(e.res.order._id)},function(e){1===t.Number(e.res.detail.status)&&(t.window.clearInterval(t.window.time),a.setState({btnLoading:!1}),y.default.success("结算成功!"),t.window.location.href="/marketing/membercard/salelog")},function(e){y.default.error(e),a.setState({btnLoading:!1})})},t.Number(l))},function(e){y.default.error(e),a.setState({btnLoading:!1})})}},{key:"hideModal",value:function(){this.setState({visible:!1,btnLoading:!1})}},{key:"getDetail",value:function(){var e=this;P.default.ajax({url:P.default.coupon.getCouponOrderDetail(this.state.id)},function(t){var a=t.res.detail;e.setState({detail:a}),e.getCustomerInfo(a.customer_id),e.getCustomerAutos(a.customer_id),e.getCouponCardTypeInfo(a.coupon_card_type)})}},{key:"getCouponCardTypeInfo",value:function(e){var t=this,a=P.default.coupon.getCouponCardTypeInfo(e);P.default.ajax({url:a},function(e){t.setState({couponCardInfo:e.res.detail})})}},{key:"getCustomerInfo",value:function(e){var t=this,a=P.default.customer.detail(e);P.default.ajax({url:a},function(e){t.setState({customer:e.res.customer_info})},function(e){y.default.error(e)})}},{key:"getCustomerAutos",value:function(e){var t=this,a=P.default.presales.superUserAutoList(e);P.default.ajax({url:a},function(e){t.setState({autos:e.res.auto_list})},function(e){y.default.error(e)})}},{key:"render",value:function(){var e=this.state,a=e.btnLoading,n=e.visible,l=e.couponCardInfo,d=e.detail;l.start_date=d.start_date,l.expire_date=d.expire_date;var u=t.JSON.parse(l.coupon_items||"[]"),s=this.state.customer||{},f=this.state.autos||[],p=this.props.form.getFieldDecorator,h=O.default.formItemFour,y=P.default.getLoginUser(),_=y.cooperationTypeShort,E="MC"===t.String(_)||"FC"===t.String(_),k=1!==t.Number(P.default.getLoginUser().companyId)&&E?"hide":"",w=[{title:"套餐卡名称",dataIndex:"name",key:"name"},{title:"售价",dataIndex:"price",key:"price"},{title:"开卡日期",dataIndex:"start_date",key:"start_date"},{title:"到期日期",dataIndex:"expire_date",key:"expire_date"},{title:"有效期(天)",dataIndex:"valid_day",key:"valid_day"},{title:"描述",dataIndex:"remark",key:"remark",width:"30%"}],S=function(e){var a=[{title:"名称",dataIndex:"name",key:"name1",width:"25%"},{title:"类型",dataIndex:"_id",key:"type",width:"25%",render:function(e){return e.length>4?"配件":"项目"}},{title:"优惠数量",dataIndex:"amount",key:"amount",width:"25%"},{title:"售价(元)",dataIndex:"price",key:"price",width:"25%",className:"1"===t.String(e.type)?"":"hide",render:function(e){return t.Number(e).toFixed(2)}},{title:"折扣",key:"discount_rate",className:"2"===t.String(e.type)?"":"hide",width:"25%",render:function(){var a=t.String(100*t.Number(t.Number(e.discount_rate).toFixed(2)));return 1===a.length?(a||"0")+"折":(0===t.Number(a.charAt(a.length-1))&&(a=a.slice(0,a.length-1)),(a||"0")+"折")}}],n=e.items&&t.JSON.parse(e.items)||[],l=e.part_types&&t.JSON.parse(e.part_types)||[],r=n.concat(l);return x.default.createElement(b.default,{className:"components-table-demo-nested",columns:a,dataSource:r,pagination:!1,rowKey:function(e){return e._id}})},D=[{title:"序号",key:"index",render:function(e,t,a){return a+1}},{title:"优惠券名称",dataIndex:"name",key:"name"},{title:"描述",dataIndex:"remark",key:"remark"},{title:"有效期",dataIndex:"valid_type",key:"valid_type",render:function(e,a){return"0"===t.String(e)?a.valid_start_date+"至"+a.valid_expire_date:"1"===t.String(e)?"领取后当天生效"+a.valid_day+"天有效":void 0}},{title:"优惠券类型",dataIndex:"type",key:"type",render:function(e){return j.default.couponType[e]}},{title:"门店",dataIndex:"scope",key:"scope",className:k,render:function(e){switch(""+e){case"0":return"适用门店";case"1":return"售卡门店";default:return null}}},{title:"数量",dataIndex:"amount",key:"amount",render:function(e){return 0===e?"不限次数":e}}],R=[x.default.createElement("div",null,x.default.createElement(m.default,{key:"btn4",type:"primary",onClick:this.handleSubmit,loading:a},"结算"),x.default.createElement(m.default,{key:"btn5",type:"ghost",onClick:this.hideModal},"取消"))],q=P.default.getLoginUser().isPosDevice,L=(0,C.default)({"icon-first-name-none":!s._id,"icon-first-name":!0}),M=(0,C.default)({"customer-info":!!s._id,hide:!s._id}),T=(0,C.default)({hide:!s._id});return x.default.createElement("div",null,x.default.createElement(v.default,{onSubmit:this.handleSubmit},x.default.createElement(i.default,null,x.default.createElement(o.default,{span:10},x.default.createElement("div",{className:"base-info",style:{borderTop:0,paddingTop:0}},x.default.createElement("div",{className:"customer-container"},x.default.createElement("div",{className:L},s.name?s.name.substr(0,1):x.default.createElement(c.default,{type:"user",style:{color:"#fff"}})),x.default.createElement("div",{className:M},x.default.createElement("div",null,x.default.createElement("span",{className:"customer-name"},s.name),x.default.createElement("span",{className:"ml6"},j.default.gender[t.String(s.gender)])),x.default.createElement("div",null,x.default.createElement("span",null,s.phone)))))),x.default.createElement(o.default,{className:1===t.Number(d.status)?"hide":"pull-right"},x.default.createElement("div",{className:1===t.Number(q)?"":"hide"},x.default.createElement(m.default,{type:"primary",htmlType:"submit",loading:a},"结算")),x.default.createElement("div",{className:0===t.Number(q)?"":"hide"},x.default.createElement(m.default,{type:"primary",onClick:this.showModal},"结算"),x.default.createElement(r.default,{visible:n,title:"结算方式",onCancel:this.hideModal,footer:R},x.default.createElement(i.default,null,x.default.createElement(o.default,{span:14},x.default.createElement(A,N({label:"支付方式"},h),p("pay_type",{initialValue:"2",rules:I.default.getRuleNotNull(),validateTrigger:"onBlur"})(x.default.createElement(g.default,{style:{width:"150px"}},x.default.createElement(F,{key:"1"},"银行转账"),x.default.createElement(F,{key:"2"},"现金支付"),x.default.createElement(F,{key:"3"},"微信支付"),x.default.createElement(F,{key:"4"},"支付宝支付")))))))))),x.default.createElement("div",{className:"member-autos-info "+T},f.map(function(e){return x.default.createElement("div",{className:"auto",key:e._id},x.default.createElement("div",null,x.default.createElement("label",{className:"label"},"车牌号"),x.default.createElement("span",null," ",e.plate_num||"")),x.default.createElement("div",null,x.default.createElement("label",{className:"label"},"车型信息"),x.default.createElement("span",null,e.auto_type_name||"")))})),x.default.createElement(i.default,{className:"mt20 mb10"},x.default.createElement(o.default,{span:4},x.default.createElement("h3",null,"开卡信息"))),x.default.createElement(b.default,{columns:w,dataSource:[l],pagination:!1,rowKey:function(e,t){return e._id+"_"+t}}),x.default.createElement("div",{className:"with-bottom-divider mt20"},x.default.createElement("div",{className:"info-line"},x.default.createElement("div",{className:"width-200"},x.default.createElement("label",{className:"label"},"销售人员"),x.default.createElement("span",null,d.seller_user_name)),x.default.createElement("div",{className:"width-200"},x.default.createElement("label",{className:"label"},"销售提成"),x.default.createElement("span",null,t.Number(l.sell_bonus_amount||0).toFixed(2)+" 元")),x.default.createElement("div",{className:"width-200"},x.default.createElement("label",{className:"label",style:{marginLeft:"27px"}},"备注"),x.default.createElement("span",{style:{color:"#2db7f5",fontSize:18,fontWeight:"bold"}},d.remark)))),x.default.createElement(i.default,{className:"mt20 mb20"},x.default.createElement(o.default,{span:4},x.default.createElement("h3",null,"结算信息"))),x.default.createElement("div",{className:"with-bottom-divider"},x.default.createElement("div",{className:"info-line"},x.default.createElement("div",{className:"width-200"},x.default.createElement("label",{className:"label"},"应收金额"),x.default.createElement("span",null,(t.Number(d.price)+t.Number(d.discount)).toFixed(2)+" 元")),x.default.createElement("div",{className:"width-200"},x.default.createElement("label",{className:"label"},"优惠金额"),x.default.createElement("span",null,t.Number(d.discount).toFixed(2)+" 元")),x.default.createElement("div",{className:"width-200"},x.default.createElement("label",{className:"label"},"实收金额"),x.default.createElement("span",{style:{color:"#2db7f5",fontSize:18,fontWeight:"bold"}},t.Number(d.price).toFixed(2)+" 元")))),x.default.createElement(i.default,{className:"mt20 mb10"},x.default.createElement(o.default,{span:4},x.default.createElement("h3",null,"卡内优惠"))),x.default.createElement("div",{className:"mb20"},x.default.createElement(b.default,{className:"components-table-demo-nested",columns:D,dataSource:u,pagination:!1,bordered:!1,expandedRowRender:S,rowKey:function(e){return e._id}}))))}}]),Sale}(T.default);U=v.default.create()(U),a.default=U},n=function(e,t,a){t=e.exports=a(14)(),t.push([e.i,".components-table-demo-nested .ant-table-expanded-row > td:last-child {\n    padding: 0 48px 0 8px;\n}\n\n.components-table-demo-nested .ant-table-expanded-row > td:last-child .ant-table-thead th {\n    border-bottom: 1px solid #e9e9e9;\n}\n\n.components-table-demo-nested .ant-table-expanded-row > td:last-child .ant-table-thead th:first-child {\n    padding-left: 0;\n}\n\n.components-table-demo-nested .ant-table-expanded-row > td:last-child .ant-table-row td:first-child {\n    padding-left: 0;\n}\n\n.components-table-demo-nested .ant-table-expanded-row .ant-table-row:last-child td {\n    border: none;\n}\n\n.components-table-demo-nested .ant-table-expanded-row .ant-table-thead > tr > th {\n    background: none;\n}\n\n.components-table-demo-nested .table-operation a:not(:last-child) {\n    margin-right: 24px;\n}",""])},l=function(e,t,a){var n=a(1773);"string"==typeof n&&(n=[[e.i,n,""]]);a(15)(n,{});n.locals&&(e.exports=n.locals)},r=e,d=r.webpackJsonp;if(r.webpackJsonp!==d)throw new Error("Prepack model invariant violation: "+r.webpackJsonp);var i=[62],u={1538:a,1773:n,1784:l};d(i,u)}).call(this);